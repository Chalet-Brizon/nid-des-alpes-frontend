<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Votre r√©servation ‚Äì Nid des Alpes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- SEO -->
  <meta name="description" content="R√©servez votre s√©jour au Nid des Alpes : un cocon chaleureux perch√© entre lac, montagnes et mer de nuages, avec vue panoramique et calme absolu.">
  <meta name="robots" content="index,follow">

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.js"></script>

  <!-- Stripe -->
  <script src="https://js.stripe.com/v3/"></script>

  <style>
    body{
      font-family:Arial,Helvetica,sans-serif;
      background:#f4f6f4;
      margin:0;
      color:#122;
    }

    header{
      background:#2f6b3a;
      color:#fff;
      padding:25px;
      text-align:center;
    }

    header h1{
      margin:0;
      font-size:1.9rem;
    }

    section{
      max-width:900px;
      margin:auto;
      padding:20px;
    }

    .card{
      background:#fff;
      padding:20px;
      border-radius:14px;
      margin-bottom:20px;
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
    }

    h3{
      color:#2f6b3a;
      margin-top:0;
      font-size:1.3rem;
    }

    input,button,textarea{
      width:100%;
      padding:10px;
      margin:6px 0;
      border-radius:8px;
      border:1px solid #ccc;
      font-size:15px;
      font-family:inherit;
    }

    button{
      background:#2f6b3a;
      color:#fff;
      border:none;
      border-radius:30px;
      font-size:16px;
      cursor:pointer;
      padding:12px;
      transition:0.2s;
    }

    button:hover{
      background:#265a31;
    }

    .disabled-btn{
      background:#aaa !important;
      cursor:not-allowed;
    }

    .option{
      border:1px solid #cce3d1;
      padding:12px;
      border-radius:10px;
      background:#f6fbf7;
      margin-top:10px;
    }

    .price{
      font-size:22px;
      font-weight:bold;
      color:#2f6b3a;
    }

    .small{
      font-size:13px;
      color:#555;
    }

    /* Voyageurs compteur */
    #voyageursBox{
      background:#eef6ee;
      padding:10px;
      border-radius:8px;
      margin-top:10px;
      font-size:14px;
      color:#2f6b3a;
      font-weight:bold;
    }

    /* Chatbot Cimy */
    #cimy-btn{
      position:fixed;
      bottom:20px;
      right:20px;
      background:#2f6b3a;
      color:white;
      padding:14px 20px;
      border-radius:30px;
      cursor:pointer;
      font-size:16px;
      box-shadow:0 4px 10px rgba(0,0,0,0.2);
      z-index:9999;
    }

    #cimy-window{
      position:fixed;
      bottom:80px;
      right:20px;
      width:320px;
      height:420px;
      background:white;
      border-radius:14px;
      box-shadow:0 4px 20px rgba(0,0,0,0.25);
      display:none;
      flex-direction:column;
      overflow:hidden;
      z-index:9999;
    }

    #cimy-header{
      background:#2f6b3a;
      color:white;
      padding:12px;
      font-weight:bold;
      text-align:center;
      cursor:pointer;
    }

    #cimy-messages{
      flex:1;
      padding:10px;
      overflow-y:auto;
      font-size:14px;
    }

    .cimy-msg{
      background:#f1f7f2;
      padding:8px 10px;
      border-radius:10px;
      margin-bottom:8px;
      max-width:90%;
    }

    .user-msg{
      background:#d9e8ff;
      margin-left:auto;
    }

    #cimy-input{
      display:flex;
      border-top:1px solid #ddd;
    }

    #cimy-text{
      flex:1;
      padding:10px;
      border:none;
      outline:none;
    }

    #cimy-send{
      background:#2f6b3a;
      color:white;
      padding:10px 14px;
      border:none;
      cursor:pointer;
    }
  </style>
</head>

<body>

<header>
  <h1>Votre r√©servation ‚Äì Nid des Alpes</h1>
</header>

<div style="text-align:center;margin:10px">
  <a href="index.html">‚Üê Retour √† l‚Äôaccueil</a>
</div>

<section>
<!-- ===========================
     FORMULAIRE DE R√âSERVATION
=========================== -->

<!-- DATES -->
<div class="card">
  <h3>1Ô∏è‚É£ Dates</h3>
  <div id="calendar"></div>

  <label>Arriv√©e</label>
  <input id="start" type="date">

  <label>D√©part</label>
  <input id="end" type="date">

  <p class="small">Minimum 2 nuits. Pour plus de 40 nuits, un devis personnalis√© vous sera propos√©.</p>
</div>

<!-- VOYAGEURS -->
<div class="card">
  <h3>2Ô∏è‚É£ Voyageurs</h3>

  <label>Adultes (‚â•18 ans)</label>
  <input id="adults" type="number" min="1" max="4" value="2">

  <label>Enfants 8‚Äì17 ans</label>
  <input id="kids817" type="number" min="0" max="2" value="0">

  <label>Enfants &lt; 8 ans (gratuit)</label>
  <input id="kidsUnder8" type="number" min="0" max="3" value="0">

  <div class="option">
    <label>
      <input type="checkbox" id="baby">
      <strong>Lit b√©b√© (-3 ans)</strong><br>
      1 b√©b√© autoris√© en plus (hors capacit√©), avec au moins 1 adulte.
    </label>
  </div>

  <div id="voyageursBox">
    Voyageurs : <span id="voyageursTotal">2</span> / <span id="voyageursMax">4</span>
  </div>

  <p class="small">
    Base tarifaire : 2 adultes inclus<br>
    +10 ‚Ç¨ / nuit par personne suppl√©mentaire (&gt;8 ans) au‚Äëdel√† de 2 personnes<br>
    Enfants &lt; 8 ans : gratuits (pas de taxe de s√©jour)
  </p>
</div>

<!-- OPTIONS -->
<div class="card">
  <h3>3Ô∏è‚É£ Options</h3>

  <div class="option">
    <label>
      <input type="checkbox" id="linge">
      <strong>Pack linge ‚Äì 10 ‚Ç¨ / s√©jour</strong><br>
      2 jeux de draps (140√ó190) ‚Ä¢ 1 housse de couette ‚Ä¢ 2 serviettes
    </label>
  </div>

  <label>Serviettes suppl√©mentaires (5 ‚Ç¨ / unit√©)</label>
  <input id="towels" type="number" min="0" max="4" value="0">
</div>

<!-- COORDONN√âES -->
<div class="card">
  <h3>4Ô∏è‚É£ Coordonn√©es</h3>
  <input id="nom" placeholder="Nom" required>
  <input id="prenom" placeholder="Pr√©nom" required>
  <input id="email" type="email" placeholder="Email" required>
  <input id="telephone" placeholder="T√©l√©phone" required>

  <textarea id="motif" placeholder="Motif du s√©jour (obligatoire pour les s√©jours > 7 nuits)" style="height:80px"></textarea>

  <label style="margin-top:10px;">
    <input type="checkbox" id="certif">
    Je certifie l‚Äôexactitude des informations fournies.
  </label>

  <p class="small">Une pi√®ce d‚Äôidentit√© pourra √™tre demand√©e √† l‚Äôarriv√©e.</p>
</div>

<!-- R√âCAP -->
<div class="card">
  <h3>5Ô∏è‚É£ R√©capitulatif</h3>

  <p>Prix s√©jour : <strong><span id="price">0</span> ‚Ç¨</strong></p>

  <p>Taxe de s√©jour : <strong><span id="taxe">0</span> ‚Ç¨</strong><br>
    <span class="small">1,50 ‚Ç¨ / nuit / adulte (+18 ans)</span>
  </p>

  <p>√âconomie r√©alis√©e : <strong><span id="eco">0</span> ‚Ç¨</strong></p>

  <p class="price">Total : <span id="total">0</span> ‚Ç¨</p>

  <div class="option">
    <strong>Garantie par empreinte bancaire ‚Äì 1 000 ‚Ç¨</strong><br>
    Aucun montant n‚Äôest d√©bit√© lors de la r√©servation.<br>
    Une empreinte bancaire de 1 000 ‚Ç¨ est demand√©e √† titre de garantie.<br>
    Un d√©bit partiel ou total pourra √™tre effectu√© uniquement en cas de
    d√©gradations constat√©es apr√®s le s√©jour, conform√©ment aux conditions accept√©es.
  </div>

  <label>
    <input type="checkbox" id="acceptCaution">
    J‚Äôaccepte la garantie par empreinte bancaire de 1 000 ‚Ç¨ et les conditions associ√©es.
  </label>

  <button id="payBtn">üîí Confirmer et payer</button>

  <button id="quoteBtn" type="button" style="margin-top:10px;display:none;">
    üì© Demander un devis pour un long s√©jour
  </button>
</div>

<!-- ===========================
     CHATBOT CIMY
=========================== -->

<div id="cimy-btn">üí¨ Cimy ‚Äì Assistance</div>

<div id="cimy-window">
  <div id="cimy-header">Cimy ‚Äì Votre conseiller virtuel</div>
  <div id="cimy-messages"></div>

  <div id="cimy-input">
    <input id="cimy-text" type="text" placeholder="√âcrire un message...">
    <button id="cimy-send">Envoyer</button>
  </div>
</div>
<!-- ===========================
     PARTIE 3 ‚Äî FULLCALENDAR + ICAL
=========================== -->

<script>
/* ===========================
   CONFIG BACKEND & STRIPE
=========================== */
const BACKEND_URL = "https://nid-des-cimes-backend.onrender.com";

/* ===========================
   LIENS ICAL
=========================== */
const ICAL_LINKS = [
  "https://ical.booking.com/v1/export?t=5b07a297-307c-4a43-ad3a-a77c49f6e149",
  "http://www.abritel.fr/icalendar/a3ebc06e8f474da79b65ecfbe22505e5.ics?nonTentative",
  "https://www.airbnb.fr/calendar/ical/1203631202385110110.ics?t=b99d47add4f5425f804095026b1eaebd"
];

/* ===========================
   PARSEUR ICS ROBUSTE
=========================== */
function parseICS(text) {
  const events = [];
  const lines = text.split(/\r?\n/);
  let current = null;

  for (let raw of lines) {
    const line = raw.trim();

    if (line === "BEGIN:VEVENT") {
      current = {};
    } else if (line.startsWith("DTSTART")) {
      const parts = line.split(":");
      if (parts.length === 2) current.start = parts[1];
    } else if (line.startsWith("DTEND")) {
      const parts = line.split(":");
      if (parts.length === 2) current.end = parts[1];
    } else if (line === "END:VEVENT") {
      if (current && current.start && current.end) events.push(current);
      current = null;
    }
  }
  return events;
}

/* ===========================
   CONVERSION ICS ‚Üí EVENTS FULLCALENDAR
=========================== */
function convertICSToEvents(icsEvents) {
  const fcEvents = [];

  function parseICSToDate(str) {
    if (!str) return null;
    const base = str.split("T")[0];
    const y = base.substring(0, 4);
    const m = base.substring(4, 6);
    const d = base.substring(6, 8);
    return new Date(+y, +m - 1, +d);
  }

  for (const ev of icsEvents) {
    const startDate = parseICSToDate(ev.start);
    const endDate = parseICSToDate(ev.end);
    if (!startDate || !endDate) continue;

    // Nuits ‚Üí rouge vif
    fcEvents.push({
      start: startDate.toISOString().split("T")[0],
      end: endDate.toISOString().split("T")[0],
      display: "background",
      color: "#ff4444"
    });

    // Matin√©e du d√©part ‚Üí rouge moyen
    const departMorningStart = new Date(endDate);
    const departMorningEnd = new Date(endDate);
    departMorningEnd.setHours(10, 0, 0, 0);

    fcEvents.push({
      start: departMorningStart.toISOString(),
      end: departMorningEnd.toISOString(),
      display: "background",
      color: "#ff6666"
    });
  }

  return fcEvents;
}

/* ===========================
   CHARGEMENT DES 3 ICAL
=========================== */
async function loadAllICS() {
  let all = [];

  for (const url of ICAL_LINKS) {
    try {
      const res = await fetch(url);
      const text = await res.text();
      const parsed = parseICS(text);
      all = all.concat(parsed);
    } catch (e) {
      console.warn("Erreur ICS :", url);
    }
  }

  return all;
}

/* ===========================
   FULLCALENDAR
=========================== */
document.addEventListener("DOMContentLoaded", async () => {
  const calendarEl = document.getElementById("calendar");

  // Charger les ICS
  const icsEvents = await loadAllICS();
  const externalEvents = convertICSToEvents(icsEvents);

  const calendar = new FullCalendar.Calendar(calendarEl, {
    locale: "fr",
    initialView: "dayGridMonth",
    selectable: true,
    height: 450,

    events: [
      ...externalEvents,
      {
        url: BACKEND_URL + "/api/bookings",
        color: "#ff4444",
        display: "background"
      }
    ],

    /* S√©lection utilisateur */
    select(info) {
      const startDate = info.startStr;
      const endDate = info.endStr;

      const nights = countNights(startDate, endDate);

      if (nights < 2) {
        alert("Minimum 2 nuits.");
        calendar.unselect();
        return;
      }

      // V√©rification chevauchement fiable
      function isOverlap(s1, e1, ev) {
        const start1 = new Date(s1);
        const end1 = new Date(e1);
        const start2 = new Date(ev.start);
        const end2 = new Date(ev.end || ev.start);
        return start1 < end2 && end1 > start2;
      }

      for (const ev of externalEvents) {
        if (isOverlap(startDate, endDate, ev)) {
          alert("Ces dates ne sont pas disponibles.");
          calendar.unselect();
          return;
        }
      }

      document.getElementById("start").value = startDate;
      document.getElementById("end").value = endDate;

      calculate();
    }
  });

  calendar.render();
});
</script>
<!-- ===========================
     PARTIE 4 ‚Äî CALCULS & ERGONOMIE
=========================== -->

<script>
/* R√©cup√©ration des √©l√©ments */
const start = document.getElementById("start");
const end = document.getElementById("end");
const adults = document.getElementById("adults");
const kids817 = document.getElementById("kids817");
const kidsUnder8 = document.getElementById("kidsUnder8");
const baby = document.getElementById("baby");
const linge = document.getElementById("linge");
const towels = document.getElementById("towels");

const priceSpan = document.getElementById("price");
const taxeSpan = document.getElementById("taxe");
const totalSpan = document.getElementById("total");
const ecoSpan = document.getElementById("eco");

const payBtn = document.getElementById("payBtn");
const quoteBtn = document.getElementById("quoteBtn");
const acceptCaution = document.getElementById("acceptCaution");

const voyageursTotal = document.getElementById("voyageursTotal");
const voyageursMax = document.getElementById("voyageursMax");

/* ===========================
   TARIFS SAISON
=========================== */
const seasons = [
  { from: "2026-01-01", to: "2026-02-06", price: 70 },
  { from: "2026-02-07", to: "2026-03-01", price: 105 },
  { from: "2026-03-02", to: "2026-05-31", price: 70 },
  { from: "2026-06-01", to: "2026-09-13", price: 95 },
  { from: "2026-09-14", to: "2026-12-13", price: 70 },
  { from: "2026-12-14", to: "2026-12-31", price: 115 }
];

function getSeasonPrice(dateStr) {
  const d = new Date(dateStr);
  for (const s of seasons) {
    const from = new Date(s.from);
    const to = new Date(s.to);
    if (d >= from && d <= to) return s.price;
  }
  return 70;
}

function countNights(start, end) {
  return (new Date(end) - new Date(start)) / 86400000;
}

/* ===========================
   ERGONOMIE VOYAGEURS
=========================== */
function updateVoyageurs() {
  let adultsV = +adults.value;
  let kids817V = +kids817.value;
  let kidsU8V = +kidsUnder8.value;

  if (adultsV < 1) {
    adults.value = 1;
    adultsV = 1;
  }

  let maxCap = baby.checked ? 5 : 4;
  let occupants = adultsV + kids817V + kidsU8V;

  if (occupants > maxCap) {
    alert("La capacit√© maximale est de " + maxCap + " personnes pour ce logement.");
    kids817.value = 0;
    kidsUnder8.value = 0;
    occupants = adultsV;
  }

  voyageursTotal.innerText = occupants;
  voyageursMax.innerText = maxCap;
}

baby.addEventListener("change", () => {
  const total = +adults.value + +kids817.value + +kidsUnder8.value;
  if (baby.checked && total >= 5) {
    alert("Impossible d‚Äôajouter un b√©b√© : capacit√© maximale atteinte.");
    baby.checked = false;
  }
  updateVoyageurs();
  calculate();
});

/* ===========================
   CALCUL PRINCIPAL
=========================== */
function calculate() {
  updateVoyageurs();

  if (!start.value || !end.value) return;

  const nights = countNights(start.value, end.value);

  if (nights < 2) {
    alert("Minimum 2 nuits.");
    end.value = "";
    priceSpan.innerText = "0";
    taxeSpan.innerText = "0";
    totalSpan.innerText = "0";
    ecoSpan.innerText = "0";
    payBtn.disabled = true;
    payBtn.classList.add("disabled-btn");
    quoteBtn.style.display = "none";
    return;
  }

  let adultsV = +adults.value;
  let kids817V = +kids817.value;
  let kidsU8V = +kidsUnder8.value;

  let total = 0;
  let totalSansReduction = 0;

  const startDate = new Date(start.value);

  for (let i = 0; i < nights; i++) {
    const d = new Date(startDate);
    d.setDate(d.getDate() + i);
    const iso = d.toISOString().split("T")[0];
    const price = getSeasonPrice(iso);
    totalSansReduction += price;
    total += price;
  }

  const payingPersons = adultsV + kids817V;
  if (payingPersons > 2) {
    const extra = payingPersons - 2;
    totalSansReduction += extra * 10 * nights;
    total += extra * 10 * nights;
  }

  if (linge.checked) {
    totalSansReduction += 10;
    total += 10;
  }

  const towelsCount = +towels.value || 0;
  totalSansReduction += towelsCount * 5;
  total += towelsCount * 5;

  if (nights >= 2 && nights <= 6) total *= 0.92;
  else if (nights >= 7 && nights <= 29) total *= 0.82;
  else if (nights >= 30 && nights <= 39) total *= 0.6;

  const taxe = adultsV * nights * 1.5;

  priceSpan.innerText = total.toFixed(2);
  taxeSpan.innerText = taxe.toFixed(2);
  totalSpan.innerText = (total + taxe).toFixed(2);

  ecoSpan.innerText = (totalSansReduction - total).toFixed(2);

  if (nights > 40) {
    payBtn.disabled = true;
    payBtn.classList.add("disabled-btn");
    quoteBtn.style.display = "block";
  } else {
    payBtn.disabled = false;
    payBtn.classList.remove("disabled-btn");
    quoteBtn.style.display = "none";
  }
}

[start, end, adults, kids817, kidsUnder8, baby, linge, towels]
  .forEach(e => e.addEventListener("change", calculate));

/* ===========================
   LOGIQUE ARRIV√âE AUJOURD‚ÄôHUI
=========================== */
function isArrivalToday(dateStr) {
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const arrival = new Date(dateStr);
  arrival.setHours(0, 0, 0, 0);

  return arrival.getTime() === today.getTime();
}

/* ===========================
   STRIPE & PR√â‚ÄëR√âSERVATION
=========================== */
const stripe = Stripe("pk_test_51SoO4ICnhuUC6TuPqxs9ZlD8wThm3VsJfiCEAHJgqT3TSvp0Xj9Gl17R1umpB136Gp6iekAU80EJ4iFHNCV6TAs600EGsQT8XC");

payBtn.onclick = async () => {
  if (payBtn.disabled) return;

  if (!acceptCaution.checked) {
    alert("Veuillez accepter la garantie par empreinte bancaire de 1 000 ‚Ç¨.");
    return;
  }

  if (!nom.value || !prenom.value || !email.value || !telephone.value) {
    alert("Veuillez remplir toutes les informations.");
    return;
  }

  if (!certif.checked) {
    alert("Veuillez certifier l‚Äôexactitude des informations.");
    return;
  }

  if (!start.value || !end.value) {
    alert("Veuillez s√©lectionner vos dates.");
    return;
  }

  const nights = countNights(start.value, end.value);

  if (nights < 2) {
    alert("Minimum 2 nuits.");
    return;
  }

  if (nights > 40) {
    alert("Pour plus de 40 nuits, merci de demander un devis.");
    return;
  }

  if (isArrivalToday(start.value)) {
    alert("Votre arriv√©e est aujourd‚Äôhui : merci de nous contacter pour une pr√©‚Äër√©servation urgente.");
    return;
  }

  const total = parseFloat(totalSpan.innerText);

  const options = [];
  if (linge.checked) options.push("Pack linge");
  if (+towels.value > 0) options.push(`Serviettes suppl√©mentaires x${towels.value}`);

  try {
    const response = await fetch(BACKEND_URL + "/create-checkout-session", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        amount: Math.round(total * 100),
        name: nom.value + " " + prenom.value,
        email: email.value,
        telephone: telephone.value,
        startDate: start.value,
        endDate: end.value,
        adults: adults.value,
        kids817: kids817.value,
        kidsUnder8: kidsUnder8.value,
        baby: baby.checked,
        options
      })
    });

    const data = await response.json();

    if (data.url) {
      window.location.href = data.url;
    } else {
      alert("Erreur lors de la cr√©ation de la session de paiement.");
    }

  } catch (error) {
    console.error(error);
    alert("Erreur de communication avec le serveur.");
  }
};
</script>

<footer>
  ¬© Nid des Alpes ‚Äì Brizon<br>
  <a href="cgv.html">CGV</a> |
  <a href="confidentialite.html">Politique de Confidentialit√©</a> |
  <a href="mentions-legales.html">Mentions L√©gales</a> |
  <a href="cookies.html">Cookies</a>
</footer>

</body>
</html>
