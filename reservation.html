<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>R√©servation ‚Äì Le Nid des Cimes</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.js"></script>
<script src="https://js.stripe.com/v3/"></script>

<style>
body{font-family:Arial;background:#f4f6f4;margin:0}
header{background:#2f6b3a;color:#fff;padding:20px;text-align:center}
section{max-width:900px;margin:auto;padding:20px}
.card{background:#fff;padding:20px;border-radius:14px;margin-bottom:20px}
h3{color:#2f6b3a;margin-top:0}
input,button{width:100%;padding:10px;margin:6px 0}
button{background:#2f6b3a;color:#fff;border:none;border-radius:30px;font-size:16px;cursor:pointer}
.option{border:1px solid #cce3d1;padding:12px;border-radius:10px;background:#f6fbf7;margin-top:10px}
.price{font-size:22px;font-weight:bold;color:#2f6b3a}
.small{font-size:13px;color:#555}
</style>
</head>

<body>

<header>
<h1>R√©server votre s√©jour</h1>
</header>

<div style="text-align:center;margin:10px">
<a href="index.html">‚Üê Retour √† l‚Äôaccueil</a>
</div>

<section>

<!-- DATES -->
<div class="card">
<h3>1Ô∏è‚É£ Dates</h3>
<div id="calendar"></div>

<label>Arriv√©e</label>
<input id="start" type="date">

<label>D√©part</label>
<input id="end" type="date">

<p class="small">Minimum 2 nuits</p>
</div>

<!-- VOYAGEURS -->
<div class="card">
<h3>2Ô∏è‚É£ Voyageurs</h3>

<label>Adultes (‚â•18 ans)</label>
<input id="adults" type="number" min="1" max="4" value="2">

<label>Enfants 8‚Äì17 ans</label>
<input id="kids817" type="number" min="0" max="2" value="0">

<label>Enfants &lt; 8 ans (gratuit)</label>
<input id="kidsUnder8" type="number" min="0" max="3" value="0">

<div class="option">
<label>
<input type="checkbox" id="baby">
<strong>Lit b√©b√© (-3 ans)</strong><br>
1 b√©b√© autoris√© en plus (hors capacit√©)
</label>
</div>

<p class="small">
Base tarifaire : 2 adultes inclus<br>
+10 ‚Ç¨ / nuit (3·µâ personne >8 ans)<br>
+20 ‚Ç¨ / nuit (4·µâ personne >8 ans)
</p>
</div>

<!-- OPTIONS -->
<div class="card">
<h3>3Ô∏è‚É£ Options</h3>

<div class="option">
<label>
<input type="checkbox" id="linge">
Pack linge ‚Äì 10 ‚Ç¨ / s√©jour<br>
2 jeux de draps ‚Ä¢ 1 housse ‚Ä¢ 2 serviettes
</label>
</div>

<label>Serviettes suppl√©mentaires (5 ‚Ç¨ / unit√©)</label>
<input id="towels" type="number" min="0" max="4" value="0">
</div>

<!-- COORDONN√âES -->
<div class="card">
<h3>4Ô∏è‚É£ Coordonn√©es</h3>
<input id="nom" placeholder="Nom" required>
<input id="prenom" placeholder="Pr√©nom" required>
<input id="email" type="email" placeholder="Email" required>
<input id="telephone" placeholder="T√©l√©phone" required>
</div>

<!-- R√âCAP -->
<div class="card">
<h3>5Ô∏è‚É£ R√©capitulatif</h3>

<p>Prix s√©jour : <strong><span id="price">0</span> ‚Ç¨</strong></p>

<p>Taxe de s√©jour : <strong><span id="taxe">0</span> ‚Ç¨</strong><br>
<span class="small">1,50 ‚Ç¨ / nuit / adulte (+18 ans)</span>
</p>

<p class="price">Total : <span id="total">0</span> ‚Ç¨</p>

<div class="option">
<strong>Caution bancaire ‚Äì 1000 ‚Ç¨</strong><br>
Aucun d√©bit aujourd‚Äôhui.<br>
Un d√©bit partiel ou total pourra √™tre effectu√© uniquement apr√®s le s√©jour.
</div>

<label>
<input type="checkbox" id="acceptCaution">
J‚Äôaccepte la caution bancaire
</label>

<button id="payBtn">üîí Confirmer et payer</button>
</div>

</section>

<script>
/* ===========================
   CALENDRIER
=========================== */
document.addEventListener("DOMContentLoaded", () => {
  const cal = new FullCalendar.Calendar(
    document.getElementById("calendar"),
    {
      locale: "fr",
      selectable: true,
      events: "https://TON-BACKEND.onrender.com/api/bookings",
      select(info) {
        const nights = (info.end - info.start) / 86400000;
        if (nights < 2) {
          alert("Minimum 2 nuits");
          return;
        }
        start.value = info.startStr;
        end.value = info.endStr;
        calculate();
      }
    }
  );
  cal.render();
});

/* ===========================
   CALCUL TARIF
=========================== */
function calculate() {
  if (!start.value || !end.value) return;

  const nights = (new Date(end.value) - new Date(start.value)) / 86400000;

  let adultsV = +adults.value;
  let kids817V = +kids817.value;
  let kidsU8V = +kidsUnder8.value;

  let occupants = adultsV + kids817V + kidsU8V;

  if (!baby.checked && occupants > 4) {
    alert("Capacit√© maximale 4 personnes");
    adults.value = 2;
    kids817.value = 0;
    kidsUnder8.value = 0;
    return;
  }

  let total = nights * 70;

  if (adultsV + kids817V >= 3) total += 10 * nights;
  if (adultsV + kids817V >= 4) total += 20 * nights;

  if (linge.checked) total += 10;
  total += towels.value * 5;

  if (nights >= 30) total *= 0.6;
  else if (nights >= 7) total *= 0.82;
  else total *= 0.92;

  const taxe = adultsV * nights * 1.5;

  price.innerText = total.toFixed(2);
  taxeSpan.innerText = taxe.toFixed(2);
  totalSpan.innerText = (total + taxe).toFixed(2);
}

const taxeSpan = document.getElementById("taxe");
const totalSpan = document.getElementById("total");

[start, end, adults, kids817, kidsUnder8, baby, linge, towels]
  .forEach(e => e.addEventListener("change", calculate));

/* ===========================
   STRIPE
=========================== */
const stripe = Stripe("pk_test_51SoO4ICnhuUC6TuPqxs9ZlD8wThm3VsJfiCEAHJgqT3TSvp0Xj9Gl17R1umpB136Gp6iekAU80EJ4iFHNCV6TAs600EGsQT8XC");

payBtn.onclick = async () => {
  if (!acceptCaution.checked) {
    alert("Veuillez accepter la caution");
    return;
  }

  if (!nom.value || !prenom.value || !email.value || !telephone.value) {
    alert("Veuillez remplir toutes les informations");
    return;
  }

  const total = parseFloat(totalSpan.innerText);
  if (!total || total <= 0) {
    alert("Montant invalide");
    return;
  }

  const res = await fetch("https://TON-BACKEND.onrender.com/create-checkout-session", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      total,
      email: email.value
    })
  }).then(r => r.json());

  if (res.url) window.location.href = res.url;
  else alert("Erreur paiement");
};
</script>

</body>
</html>
